name: Postmortem Onboarding

on:
  workflow_dispatch:
    inputs:
      force:
        description: 'Force regenerate all postmortems (skip existing check)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || 'https://api.openai.com' }}
  OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'claude-sonnet-4-5' }}

jobs:
  onboarding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史

      - name: Setup jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run Postmortem Onboarding
        run: |
          chmod +x scripts/postmortem.sh
          ./scripts/postmortem.sh onboarding

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain postmortem/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: add postmortem reports from historical fix commits"
          title: "[Postmortem] Onboarding - Historical Bug Analysis"
          body: |
            ## Postmortem Onboarding

            This PR contains automatically generated postmortem reports from historical fix commits.

            ### What's included
            - Analysis of all `fix:` commits in the repository history
            - Root cause analysis for each bug
            - Detection patterns for future prevention

            ### Review checklist
            - [ ] Review each postmortem for accuracy
            - [ ] Verify detection patterns are correct
            - [ ] Add any missing context or details

            ---
            *Generated by Postmortem AI Analysis*
          branch: postmortem/onboarding
          delete-branch: true
          labels: |
            documentation
            postmortem
