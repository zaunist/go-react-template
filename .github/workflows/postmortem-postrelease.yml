name: Post-release Postmortem Generation

on:
  release:
    types:
      - published

  workflow_dispatch:
    inputs:
      previous_tag:
        description: 'Previous release tag (e.g., v1.0.0)'
        required: false
      current_tag:
        description: 'Current release tag (e.g., v1.1.0)'
        required: false

permissions:
  contents: write
  pull-requests: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || 'https://api.openai.com' }}
  OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'claude-sonnet-4-5' }}

jobs:
  post-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Determine tags
        id: tags
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            current_tag="${{ github.event.release.tag_name }}"

            # 获取上一个 tag
            previous_tag=$(git tag --sort=-creatordate | grep -v "^${current_tag}$" | head -1 || echo "")

            echo "current_tag=$current_tag" >> $GITHUB_OUTPUT
            echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT
          else
            echo "current_tag=${{ inputs.current_tag }}" >> $GITHUB_OUTPUT
            echo "previous_tag=${{ inputs.previous_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Post-release Analysis
        run: |
          chmod +x scripts/postmortem.sh

          prev="${{ steps.tags.outputs.previous_tag }}"
          curr="${{ steps.tags.outputs.current_tag }}"

          if [[ -n "$prev" && -n "$curr" ]]; then
            ./scripts/postmortem.sh post-release "$prev" "$curr"
          else
            ./scripts/postmortem.sh post-release
          fi

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain postmortem/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "new_files=$(git status --porcelain postmortem/ | grep '??' | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "new_files=0" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: add postmortem reports for release ${{ steps.tags.outputs.current_tag }}"
          title: "[Postmortem] Release ${{ steps.tags.outputs.current_tag }} - Bug Analysis"
          body: |
            ## Post-release Postmortem

            This PR contains automatically generated postmortem reports for fix commits in release **${{ steps.tags.outputs.current_tag }}**.

            ### Release Info
            - **Current Tag**: ${{ steps.tags.outputs.current_tag }}
            - **Previous Tag**: ${{ steps.tags.outputs.previous_tag || 'N/A' }}
            - **New Postmortems**: ${{ steps.changes.outputs.new_files }}

            ### What's included
            - Root cause analysis for each bug fix
            - Detection patterns for future prevention
            - Links to related historical postmortems (if any)

            ### Review checklist
            - [ ] Review each postmortem for accuracy
            - [ ] Verify detection patterns are correct
            - [ ] Add any missing context or details
            - [ ] Update related postmortems if needed

            ---
            *Generated by Postmortem AI Analysis*
          branch: postmortem/release-${{ steps.tags.outputs.current_tag }}
          delete-branch: true
          labels: |
            documentation
            postmortem
            release

      - name: Summary
        run: |
          echo "## Post-release Postmortem Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "✅ Generated ${{ steps.changes.outputs.new_files }} new postmortem report(s)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A PR has been created with the new postmortem files." >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No new fix commits found in this release." >> $GITHUB_STEP_SUMMARY
          fi
