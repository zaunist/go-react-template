name: Pre-release Postmortem Check

on:
  # Âú®ÂàõÂª∫ Release ‰πãÂâçÊâãÂä®Ëß¶ÂèëÊ£ÄÊü•
  workflow_dispatch:
    inputs:
      base_ref:
        description: 'Base reference (tag or branch)'
        required: false
        default: 'origin/main'
      head_ref:
        description: 'Head reference to check'
        required: false
        default: 'HEAD'

  # ÊàñËÄÖÂú® PR ÂêàÂπ∂Âà∞ main Êó∂Ëá™Âä®Ê£ÄÊü•
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize

permissions:
  contents: read
  pull-requests: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || 'https://api.openai.com' }}
  OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'claude-sonnet-4-5' }}

jobs:
  pre-release-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Determine refs
        id: refs
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "base_ref=origin/${{ github.base_ref }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "base_ref=${{ inputs.base_ref || 'origin/main' }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ inputs.head_ref || 'HEAD' }}" >> $GITHUB_OUTPUT
          fi

      - name: Check for existing postmortems
        id: check_postmortems
        run: |
          if [[ -d "postmortem" ]] && [[ -n $(find postmortem -name "PM-*.md" 2>/dev/null) ]]; then
            echo "has_postmortems=true" >> $GITHUB_OUTPUT
          else
            echo "has_postmortems=false" >> $GITHUB_OUTPUT
            echo "::warning::No postmortem files found. Run onboarding first."
          fi

      - name: Run Pre-release Check
        id: prerelease
        if: steps.check_postmortems.outputs.has_postmortems == 'true'
        run: |
          chmod +x scripts/postmortem.sh

          # ÊçïËé∑ËæìÂá∫ÂíåÈÄÄÂá∫Á†Å
          set +e
          output=$(./scripts/postmortem.sh pre-release "${{ steps.refs.outputs.base_ref }}" "${{ steps.refs.outputs.head_ref }}" 2>&1)
          exit_code=$?
          set -e

          echo "$output"

          # ‰øùÂ≠òÁªìÊûúÁî®‰∫é PR ËØÑËÆ∫
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # ÊèêÂèñ JSON ÁªìÊûú
          json_result=$(echo "$output" | grep -A 1000 "Analysis Result" | tail -n +2 | head -n -3 || echo "{}")
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$json_result" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $exit_code

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const hasPostmortems = '${{ steps.check_postmortems.outputs.has_postmortems }}' === 'true';
            const exitCode = '${{ steps.prerelease.outputs.exit_code }}' || '0';
            const result = `${{ steps.prerelease.outputs.result }}` || '{}';

            let body = '## üîç Postmortem Pre-release Check\n\n';

            if (!hasPostmortems) {
              body += '‚ö†Ô∏è **No postmortem files found.** Run the onboarding workflow first to analyze historical bugs.\n';
            } else if (exitCode === '0') {
              body += '‚úÖ **No known issues detected.** This PR is safe to merge.\n';
            } else {
              body += '‚ùå **Potential issues detected!** Please review before merging.\n\n';
              body += '### Analysis Result\n\n';
              body += '```json\n' + result + '\n```\n\n';
              body += '### Recommended Actions\n';
              body += '1. Review the detected patterns\n';
              body += '2. Verify if the changes actually trigger the historical issues\n';
              body += '3. If false positive, proceed with merge\n';
              body += '4. If true positive, fix the issues before merging\n';
            }

            body += '\n---\n*Generated by Postmortem AI Analysis*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if high/medium risk
        if: steps.prerelease.outputs.exit_code != '0' && steps.prerelease.outputs.exit_code != ''
        run: |
          echo "::error::Pre-release check failed. Potential issues detected that may trigger historical bugs."
          exit 1
