name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: prev_tag
        run: |
          current_tag="${{ github.ref_name }}"
          previous_tag=$(git tag --sort=-creatordate | grep -v "^${current_tag}$" | head -1 || echo "")
          echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT

      - name: Generate release title
        id: title
        run: |
          quote=$(curl -s https://v1.hitokoto.cn/ | jq -r '.hitokoto // "Stay hungry, stay foolish."')
          echo "quote=$quote" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          current_tag="${{ github.ref_name }}"
          previous_tag="${{ steps.prev_tag.outputs.previous_tag }}"

          echo "## What's Changed" > changelog.md
          echo "" >> changelog.md

          if [[ -n "$previous_tag" ]]; then
            # 获取两个 tag 之间的 commit
            git log --pretty=format:"* %s (%h)" "${previous_tag}..${current_tag}" >> changelog.md
          else
            # 如果没有之前的 tag，获取所有 commit
            git log --pretty=format:"* %s (%h)" >> changelog.md
          fi

          echo "" >> changelog.md
          echo "" >> changelog.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${previous_tag}...${current_tag}" >> changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ github.ref_name }} -- \"${{ steps.title.outputs.quote }}\""
          body_path: changelog.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
