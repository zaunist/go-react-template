# Postmortem: PM-20260113-007 - GitHub Actions 创建 PR 权限不足

## 基本信息

| 字段 | 值 |
|------|-----|
| **Bug ID** | PM-20260113-007 |
| **严重程度** | Medium |
| **影响范围** | CI/CD Pipeline - Postmortem 自动化流程 |
| **发现时间** | 2026-01-13 |
| **修复时间** | 2026-01-13 |
| **修复 Commit** | 06c4d8f5f2b98393327e8fc23229880b7459f2d5 |

## 问题描述

### 现象
在 `postmortem-postrelease.yml` workflow 中，使用 `peter-evans/create-pull-request@v6` action 创建 Pull Request 时失败，无法自动创建包含 Postmortem 报告的 PR。

### 根因分析

**Why 1**: 为什么 PR 创建失败？
- 因为 `create-pull-request` action 使用的 token 权限不足

**Why 2**: 为什么 token 权限不足？
- 因为使用了 `GITHUB_TOKEN`，这是 GitHub Actions 自动生成的临时 token

**Why 3**: 为什么 `GITHUB_TOKEN` 权限不足？
- 在某些上下文中（特别是 workflow 触发的 workflow），`GITHUB_TOKEN` 有意限制了权限，无法触发新的 workflow 或创建某些类型的 PR

**Why 4**: 为什么会有这种限制？
- GitHub 的安全机制：防止 workflow 无限递归触发，避免恶意代码通过 workflow 链式传播

**Why 5**: 为什么没有提前配置正确的 token？
- 初始配置时未充分理解 `GITHUB_TOKEN` 的权限限制场景，缺少对 GitHub Actions 权限模型的深入了解

**根本原因**: 
对 GitHub Actions 权限模型理解不足，特别是 `GITHUB_TOKEN` 在 workflow 间调用场景下的权限限制。需要使用具有完整权限的 Personal Access Token (PAT) 来执行需要触发后续 workflow 的操作。

### 影响评估
- **用户影响**: 无直接用户影响，仅影响内部开发流程
- **系统影响**: Postmortem 报告无法自动通过 PR 提交，需要手动创建 PR，降低了自动化效率
- **数据影响**: 无数据损坏或丢失，仅影响工作流程

## 修复方案

### 代码变更
```yaml
# 修改前
with:
  token: ${{ secrets.GITHUB_TOKEN }}

# 修改后
with:
  token: ${{ secrets.PAT_TOKEN }}
```

### 修复文件
- `.github/workflows/postmortem-postrelease.yml`

### 技术细节
- **GITHUB_TOKEN**: 自动生成的临时 token，权限受限，无法触发新的 workflow runs
- **PAT_TOKEN**: Personal Access Token，需要在 Repository Secrets 中配置，具有完整的仓库操作权限
- **权限要求**: `repo` scope（包括 `repo:status`, `repo_deployment`, `public_repo`）

## 预防措施

### 短期措施
- [x] 确认 `PAT_TOKEN` 已在 Repository Secrets 中正确配置
- [x] 验证 PAT token 具有必要的权限 scope
- [ ] 测试 workflow 能否成功创建 PR

### 长期措施
- [ ] 建立 GitHub Actions 权限模型文档，说明何时使用 `GITHUB_TOKEN` vs `PAT_TOKEN`
- [ ] 在 workflow 模板中添加权限要求注释
- [ ] 定期审查和轮换 PAT token（建议 90 天）
- [ ] 考虑使用 GitHub App token 替代 PAT，提供更细粒度的权限控制

## 检测规则

### 代码模式
```yaml
# 反模式：在需要触发 workflow 的场景使用 GITHUB_TOKEN
# 检测 create-pull-request action 使用 GITHUB_TOKEN
- uses: peter-evans/create-pull-request@*
  with:
    token: ${{ secrets.GITHUB_TOKEN }}

# 其他可能需要 PAT 的场景
- uses: actions/checkout@*
  with:
    token: ${{ secrets.GITHUB_TOKEN }}
    # 当需要 push 触发其他 workflow 时

# 推荐模式：明确标注 token 类型和用途
- uses: peter-evans/create-pull-request@v6
  with:
    token: ${{ secrets.PAT_TOKEN }}  # Required: PAT for triggering workflows
```

### 关键词
- `GITHUB_TOKEN`
- `PAT_TOKEN`
- `create-pull-request`
- `peter-evans/create-pull-request`
- `workflow permissions`
- `token permissions`

### 检测脚本
```bash
# 检查 workflow 文件中可能的权限问题
grep -r "create-pull-request" .github/workflows/ | \
  grep "GITHUB_TOKEN" && \
  echo "⚠️  Warning: create-pull-request using GITHUB_TOKEN may fail in some contexts"
```

## 经验教训

### 做得好的地方
- 快速识别问题并定位到权限配置
- Commit message 清晰说明了问题原因和解决方案
- 使用 Co-Authored-By 标注协作者

### 需要改进的地方
- **文档不足**: 缺少 GitHub Actions 权限模型的内部文档
- **测试覆盖**: 新增 workflow 时未充分测试权限场景
- **配置管理**: 应在 workflow 文件中添加注释说明 token 选择的原因
- **安全实践**: 需要建立 PAT token 管理和轮换机制

## 相关链接

- Commit: [06c4d8f](https://github.com/repo/commit/06c4d8f5f2b98393327e8fc23229880b7459f2d5)
- GitHub Docs: [Automatic token authentication](https://docs.github.com/en/actions/security-guides/automatic-token-authentication)
- GitHub Docs: [GITHUB_TOKEN permissions](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token)
- Action: [peter-evans/create-pull-request](https://github.com/peter-evans/create-pull-request)

## 附加说明

### PAT Token 配置指南
1. 生成 PAT: Settings → Developer settings → Personal access tokens → Tokens (classic)
2. 必需权限: `repo` (Full control of private repositories)
3. 配置 Secret: Repository Settings → Secrets and variables → Actions → New repository secret
4. 名称: `PAT_TOKEN`
5. 过期时间: 建议 90 天，并设置日历提醒

### 安全考虑
- PAT token 具有广泛权限，应严格限制访问
- 定期审查使用 PAT 的 workflow，确保必要性
- 考虑迁移到 GitHub App token 以获得更细粒度的权限控制
- 启用 secret scanning 防止 token 泄露
