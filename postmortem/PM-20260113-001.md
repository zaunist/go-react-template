# Postmortem: PM-20260113-001 - _redirects 文件未正确加载导致 SPA 路由失效

## 基本信息

| 字段 | 值 |
|------|-----|
| **Bug ID** | PM-20260113-001 |
| **严重程度** | High |
| **影响范围** | Web 前端 - SPA 路由系统、SEO 相关功能 |
| **发现时间** | 2025-12-23 |
| **修复时间** | 2025-12-23 |
| **修复 Commit** | 4fb2fa7ff8d53ca5c07a5e1189fd65e5b32dd9e5 |

## 问题描述

### 现象
- 用户在 Cloudflare Pages 部署环境中直接访问非首页路由（如 `/tools/watermark-remover`）时返回 404 错误
- 刷新页面时 SPA 路由失效，无法正确 fallback 到 `index.html`
- 搜索引擎爬虫无法正确索引网站内容，缺少 `sitemap.xml`、`robots.txt` 等 SEO 必需文件
- AI 爬虫无法获取网站结构信息（缺少 `llms.txt`）

### 根因分析

**Why 1**: 为什么 SPA 路由在生产环境失效？
- 因为 Cloudflare Pages 没有正确的重定向规则，无法将所有路由请求 fallback 到 `index.html`

**Why 2**: 为什么没有重定向规则？
- 因为项目中缺少 `_redirects` 文件，该文件是 Cloudflare Pages 识别重定向规则的标准配置文件

**Why 3**: 为什么之前没有发现这个问题？
- 因为在本地开发环境中，Vite dev server 自动处理了 SPA 路由的 fallback，掩盖了生产环境的配置缺失

**Why 4**: 为什么 SEO 相关文件缺失？
- 因为项目初期专注于功能开发，未考虑 SEO 优化和搜索引擎可见性需求

**根本原因**: 
1. 缺少 Cloudflare Pages 部署所需的 `_redirects` 配置文件
2. 缺少 SEO 基础设施（sitemap、robots.txt）
3. 开发环境与生产环境行为差异未被充分测试

### 影响评估
- **用户影响**: 
  - 无法通过直接 URL 访问应用内页面
  - 无法分享或收藏特定工具页面
  - 刷新页面导致 404 错误，用户体验严重受损
  
- **系统影响**: 
  - SPA 路由系统在生产环境完全失效
  - 搜索引擎无法正确爬取和索引网站内容
  - 网站在搜索结果中的可见性为零
  
- **数据影响**: 
  - 无数据损坏或丢失
  - 但可能导致流量损失和 SEO 排名机会丧失

## 修复方案

### 代码变更

**1. 添加 Cloudflare Pages 重定向配置**
```plaintext
# web/public/_redirects
/*    /index.html   200
```

**2. 创建 Vite sitemap 生成插件**
```typescript
// web/plugins/sitemap.ts
- 实现构建时自动生成 sitemap.xml
- 支持配置路由优先级和更新频率
- 在 closeBundle 钩子中生成文件到 dist 目录
```

**3. 添加 SEO 基础文件**
```plaintext
# web/public/robots.txt
- 允许所有爬虫访问
- 指向 sitemap.xml 位置

# web/public/llms.txt
- 提供网站结构和功能描述
- 面向 AI 爬虫的机器可读文档
```

**4. 配置 Vite 构建流程**
```typescript
// web/vite.config.ts
- 集成 sitemapPlugin
- 配置网站路由和优先级
- 确保 public 目录文件正确复制到 dist
```

### 修复文件
- `web/plugins/sitemap.ts` (新增)
- `web/public/_redirects` (新增)
- `web/public/llms.txt` (新增)
- `web/public/robots.txt` (新增)
- `web/vite.config.ts` (修改)

## 预防措施

### 短期措施
- [x] 添加 `_redirects` 文件到 public 目录
- [x] 实现 sitemap 自动生成机制
- [x] 添加基础 SEO 文件（robots.txt, llms.txt）
- [ ] 在 CI/CD 流程中验证 `_redirects` 文件存在
- [ ] 添加生产环境部署后的路由可访问性测试

### 长期措施
- [ ] 建立部署前检查清单，包含平台特定配置文件验证
- [ ] 创建生产环境与开发环境一致性测试套件
- [ ] 实现自动化 SEO 审计工具集成到 CI/CD
- [ ] 建立 Cloudflare Pages 部署最佳实践文档
- [ ] 添加 sitemap 内容的自动化测试
- [ ] 实现路由配置的类型安全检查

## 检测规则

### 代码模式

**缺失 _redirects 文件检测**
```bash
# Pre-release 检查脚本
if [ ! -f "web/public/_redirects" ]; then
  echo "ERROR: Missing _redirects file for Cloudflare Pages"
  exit 1
fi
```

**SPA 配置验证**
```typescript
// 检查 Vite 配置是否包含必要的 public 文件
const requiredPublicFiles = ['_redirects', 'robots.txt', 'sitemap.xml'];
// 验证 dist 目录中是否存在这些文件
```

**Sitemap 路由一致性检查**
```typescript
// 确保 sitemap 配置的路由与实际路由定义一致
// 检查 sitemapRoutes 是否覆盖所有公开路由
```

### 关键词
- `_redirects`
- `Cloudflare Pages`
- `SPA fallback`
- `sitemap.xml`
- `robots.txt`
- `llms.txt`
- `public directory`
- `vite.config.ts`
- `closeBundle`
- `SEO`

## 经验教训

### 做得好的地方
- 一次性解决了多个相关问题（路由、SEO、AI 爬虫支持）
- 实现了可复用的 sitemap 生成插件，支持灵活配置
- 添加了详细的注释说明配置用途
- 采用了声明式的路由配置方式，便于维护
- 使用 TypeScript 确保类型安全

### 需要改进的地方
- **部署前测试不足**: 未在类生产环境中验证 SPA 路由行为
- **平台特定配置缺失**: 对 Cloudflare Pages 的配置要求了解不足
- **SEO 规划滞后**: 应在项目初期就考虑 SEO 基础设施
- **文档缺失**: 缺少部署平台配置要求的文档说明
- **监控盲区**: 没有生产环境路由可访问性监控
- **开发与生产环境差异**: 需要更好的工具来发现环境差异

## 相关链接

- Commit: [4fb2fa7ff8d53ca5c07a5e1189fd65e5b32dd9e5](https://github.com/zaunist/mdzz/commit/4fb2fa7ff8d53ca5c07a5e1189fd65e5b32dd9e5)
- Cloudflare Pages 文档: https://developers.cloudflare.com/pages/configuration/redirects/
- Sitemap 协议: https://www.sitemaps.org/protocol.html
- llms.txt 规范: https://llmstxt.org/
