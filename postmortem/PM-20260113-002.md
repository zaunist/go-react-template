# Postmortem: PM-20260113-002 - Go SQLite3 构建失败（缺少 CGO 支持）

## 基本信息

| 字段 | 值 |
|------|-----|
| **Bug ID** | PM-20260113-002 |
| **严重程度** | High |
| **影响范围** | 构建系统、Docker 镜像构建、本地开发环境 |
| **发现时间** | 2025-12-22 |
| **修复时间** | 2025-12-22 |
| **修复 Commit** | fd4eb414cbe61e6ce2a240d674b847a72c6e7ef0 |

## 问题描述

### 现象
- Docker 镜像构建失败，后端编译阶段报错
- 本地执行 `make build` 或 `scripts/build.sh` 时 Go 编译失败
- 错误信息可能包含 go-sqlite3 相关的 C 编译错误或链接错误

### 根因分析

**5 Whys 分析:**

1. **Why**: 为什么构建失败？
   - 因为 Go 编译器无法编译 go-sqlite3 依赖包

2. **Why**: 为什么无法编译 go-sqlite3？
   - 因为 go-sqlite3 是一个 CGO 包，需要 C 编译器支持

3. **Why**: 为什么没有 C 编译器支持？
   - 因为构建时 `CGO_ENABLED=0`（Go 默认在某些环境下禁用 CGO）或缺少 C 编译工具链

4. **Why**: 为什么 Docker 镜像中缺少 C 编译工具链？
   - 因为 alpine 基础镜像默认不包含 gcc 和 musl-dev

5. **Why**: 为什么之前没有显式启用 CGO？
   - 因为构建配置中未考虑 SQLite3 驱动的 CGO 依赖要求

**根本原因**: 项目使用了 go-sqlite3 数据库驱动，该驱动依赖 CGO（C 语言绑定），但构建环境中：
1. 未显式设置 `CGO_ENABLED=1`
2. Docker 镜像缺少必要的 C 编译工具链（gcc、musl-dev）

### 影响评估
- **用户影响**: 无法构建和部署应用，阻塞所有新版本发布
- **系统影响**: CI/CD 流水线失败，Docker 镜像无法生成
- **数据影响**: 无数据损坏或丢失（构建阶段问题）

## 修复方案

### 代码变更

**Dockerfile 修改:**
```dockerfile
# 添加 CGO 必需的编译工具
RUN apk add --no-cache git make bash gcc musl-dev

# 启用 CGO 进行构建
RUN CGO_ENABLED=1 go build -o server main.go
```

**Makefile 修改:**
```makefile
# 本地构建时启用 CGO
CGO_ENABLED=1 go build -o server main.go
```

**scripts/build.sh 修改:**
```bash
# 构建脚本中启用 CGO
CGO_ENABLED=1 go build -o server main.go
```

**docker-compose.yml 修改:**
```yaml
# 移除过时的 version 字段（Docker Compose v2+ 不再需要）
```

### 修复文件
- `Dockerfile` - 添加 gcc 和 musl-dev 依赖，启用 CGO
- `Makefile` - 构建目标中添加 CGO_ENABLED=1
- `scripts/build.sh` - 构建脚本中添加 CGO_ENABLED=1
- `docker-compose.yml` - 清理过时配置

## 预防措施

### 短期措施
- [x] 在所有构建入口点显式设置 `CGO_ENABLED=1`
- [ ] 添加构建前置检查脚本，验证 CGO 依赖是否满足
- [ ] 在 CI/CD 文档中明确标注 CGO 依赖要求
- [ ] 添加构建失败时的错误提示，说明可能的 CGO 相关问题

### 长期措施
- [ ] 建立依赖审查流程，在引入 CGO 依赖时进行评估和文档化
- [ ] 考虑使用纯 Go 实现的 SQLite 驱动（如 modernc.org/sqlite）以避免 CGO 依赖
- [ ] 在项目 README 中添加构建依赖说明章节
- [ ] 创建开发环境配置检查工具，自动验证编译环境
- [ ] 添加单元测试覆盖构建配置的正确性

## 检测规则

### 代码模式

**触发条件（需要人工审查）:**
```go
// 当 import 中包含以下 CGO 依赖时
import (
    _ "github.com/mattn/go-sqlite3"
    // 或其他 CGO 依赖包
)
```

**Dockerfile 检查模式:**
```dockerfile
# 如果使用 alpine 且需要 CGO，必须包含:
RUN apk add --no-cache gcc musl-dev

# 构建命令必须包含:
RUN CGO_ENABLED=1 go build
```

**构建脚本检查模式:**
```bash
# 检查是否缺少 CGO_ENABLED 设置
if grep -q "go build" && ! grep -q "CGO_ENABLED=1"; then
    echo "Warning: CGO may be required"
fi
```

### 关键词
- `go-sqlite3`
- `CGO_ENABLED`
- `gcc`
- `musl-dev`
- `cgo`
- `alpine`
- `go build`
- `github.com/mattn/go-sqlite3`

## 经验教训

### 做得好的地方
- 修复方案全面覆盖了所有构建入口点（Docker、Makefile、脚本）
- 添加了清晰的注释说明 CGO 依赖的原因
- 同时修复了 docker-compose.yml 中的过时配置

### 需要改进的地方
- **依赖管理**: 引入 CGO 依赖时缺少充分的评估和文档
- **构建验证**: 缺少自动化的构建环境检查机制
- **文档完善**: 项目文档中未说明构建依赖要求
- **CI/CD 测试**: 应在多种环境下测试构建流程（本地、Docker、CI）
- **错误提示**: 构建失败时的错误信息不够明确，难以快速定位问题

## 相关链接

- Issue: 构建系统相关 issue
- PR: fd4eb414cbe61e6ce2a240d674b847a72c6e7ef0
- 相关文档: 
  - [go-sqlite3 官方文档](https://github.com/mattn/go-sqlite3)
  - [CGO 官方说明](https://golang.org/cmd/cgo/)
  - [Alpine Linux 包管理](https://pkgs.alpinelinux.org/)
