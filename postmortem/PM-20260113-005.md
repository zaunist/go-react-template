# Postmortem: PM-20260113-005 - API URI 配置错误导致请求失败

## 基本信息

| 字段 | 值 |
|------|-----|
| **Bug ID** | PM-20260113-005 |
| **严重程度** | High |
| **影响范围** | Web 前端 - API 请求模块、登录页面 |
| **发现时间** | 2025-06-18 |
| **修复时间** | 2025-06-18 |
| **修复 Commit** | 9a6e52a6f54a05688d3f4b73b338283a427a0be7 |

## 问题描述

### 现象
- 前端应用在调用后端 API 时出现 URI 路径错误
- 所有 API 请求可能被错误地添加了 `/api` 前缀，导致请求路径不正确
- 用户无法正常完成登录等需要调用后端接口的操作

### 根因分析

**5 Whys 分析:**

1. **Why**: API 请求失败？
   - 因为请求的 URI 路径不正确

2. **Why**: URI 路径为什么不正确？
   - 因为 `API_BASE_URL` 默认值设置为 `/api`，导致实际请求时路径被错误拼接

3. **Why**: 为什么 `/api` 前缀会导致问题？
   - 因为后端路由配置或反向代理已经处理了路径前缀，前端不应该再添加 `/api`

4. **Why**: 为什么会设置错误的默认值？
   - 因为对部署环境的路由配置理解不足，或者环境配置发生了变化

5. **Why**: 为什么没有在测试中发现？
   - 因为可能缺少针对不同环境配置的集成测试

**根本原因**: API 基础 URL 的默认值配置错误，当环境变量 `VITE_API_BASE_URL` 未设置时，使用了不正确的 fallback 值 `/api`，导致所有 API 请求路径错误。

### 影响评估
- **用户影响**: 
  - 所有依赖后端 API 的功能无法正常使用
  - 用户无法登录系统
  - Google OAuth 登录功能受影响
  - 影响范围：所有未正确配置环境变量的部署环境
  
- **系统影响**: 
  - 前端与后端通信完全中断
  - 所有 HTTP 请求返回 404 或其他错误状态码
  - 可能触发大量错误日志
  
- **数据影响**: 
  - 无数据损坏或丢失
  - 仅影响数据的读取和写入操作的可用性

## 修复方案

### 代码变更

**主要修复 (client.ts):**
```typescript
// 修复前
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || '/api'

// 修复后
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || ''
```

**次要优化 (LoginPage.tsx):**
```tsx
// 修复前
<div className="flex justify-center mb-6">
  <div ref={googleButtonRef} className="w-full" />
</div>

// 修复后
<div className="flex justify-center mb-6" ref={googleButtonRef} />
```

### 修复文件
- `web/src/lib/client.ts` - 修复 API 基础 URL 配置
- `web/src/pages/LoginPage.tsx` - 简化 Google 登录按钮容器结构

## 预防措施

### 短期措施
- [x] 将 `API_BASE_URL` 默认值改为空字符串
- [ ] 在所有部署环境中明确配置 `VITE_API_BASE_URL` 环境变量
- [ ] 添加启动时的配置验证，检查 API 连接是否正常
- [ ] 在开发文档中明确说明环境变量配置要求

### 长期措施
- [ ] 建立环境配置的最佳实践文档
- [ ] 实现配置管理中心，统一管理不同环境的配置
- [ ] 添加端到端测试，覆盖不同环境配置场景
- [ ] 实现前端健康检查机制，在应用启动时验证 API 可达性
- [ ] 添加 CI/CD 流程中的配置验证步骤
- [ ] 实现更友好的错误提示，当 API 不可达时给出明确的配置指引

## 检测规则

### 代码模式

**反模式 - 需要避免:**
```typescript
// ❌ 硬编码的 API 路径前缀作为 fallback
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || '/api'
const API_BASE_URL = process.env.API_URL || '/v1/api'

// ❌ 未验证的环境变量使用
const baseUrl = import.meta.env.VITE_API_BASE_URL
axios.create({ baseURL: baseUrl })
```

**最佳实践:**
```typescript
// ✅ 使用空字符串或相对路径作为 fallback
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || ''

// ✅ 添加配置验证
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || ''
if (!API_BASE_URL && process.env.NODE_ENV === 'production') {
  console.warn('VITE_API_BASE_URL is not configured')
}

// ✅ 提供明确的配置说明
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || '' // 默认使用相对路径，生产环境需配置
```

### 关键词
- `API_BASE_URL`
- `VITE_API_BASE_URL`
- `import.meta.env`
- `baseURL`
- `axios.create`
- `fallback value`
- `/api` (作为硬编码路径前缀)
- `wrong uri`
- `wrong url`

## 经验教训

### 做得好的地方
- 快速定位并修复了问题，从发现到修复在同一天完成
- Commit 信息简洁明确，使用了规范的 `fix:` 前缀
- 同时进行了代码优化（LoginPage 组件简化），提高了代码质量

### 需要改进的地方
- **环境配置管理**: 需要建立更完善的环境变量配置和验证机制
- **测试覆盖**: 缺少针对不同环境配置的集成测试
- **文档完善**: 需要在项目文档中明确说明所有必需的环境变量
- **错误处理**: 前端应该在 API 配置错误时提供更友好的错误提示
- **Code Review**: 在 Code Review 中应该特别关注环境配置相关的变更
- **部署检查清单**: 建立部署前的配置检查清单，确保所有环境变量正确配置

## 相关链接

- Issue: [需要补充]
- PR: [需要补充]
- 相关文档: 环境变量配置指南（待创建）
- 相关 Postmortem: 无
