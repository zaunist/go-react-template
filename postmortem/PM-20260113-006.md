# Postmortem: PM-20260113-006 - 移除 bun.lock 文件并修改依赖安装策略

## 基本信息

| 字段 | 值 |
|------|-----|
| **Bug ID** | PM-20260113-006 |
| **严重程度** | Medium |
| **影响范围** | 前端依赖管理、构建流程 |
| **发现时间** | 2025-06-13 |
| **修复时间** | 2025-06-13 |
| **修复 Commit** | 2bc306733043f68e0c28415ad5bdf734db75450c |

## 问题描述

### 现象
- 项目中存在 `web/bun.lock` 锁文件，可能导致依赖版本锁定问题
- 依赖安装过程可能使用了缓存，导致某些场景下依赖不一致或更新不及时
- 766 行的 lockfile 被完全移除

### 根因分析
1. **为什么移除 bun.lock？**
   - lockfile 可能导致依赖版本固化，在某些环境下无法获取最新的补丁版本

2. **为什么添加 --no-cache 参数？**
   - 缓存可能导致依赖安装不一致，特别是在 CI/CD 环境或多人协作时
   - 强制从源重新下载可以确保依赖的新鲜度和一致性

3. **为什么这是必要的？**
   - 可能遇到了依赖版本不一致导致的构建或运行时问题
   - 需要确保每次安装都获取符合 package.json 语义化版本范围的最新版本

4. **为什么不保留 lockfile？**
   - 项目可能处于快速迭代阶段，需要灵活的依赖管理
   - 或者团队决定采用更激进的依赖更新策略

5. **根本原因**
   - 依赖管理策略调整：从严格锁定版本转向更灵活的版本管理
   - 可能是为了解决特定的依赖冲突或版本不一致问题

### 影响评估
- **用户影响**: 
  - 短期：可能导致构建时间增加（无缓存）
  - 长期：可能因依赖版本不固定导致潜在的不稳定性
  
- **系统影响**: 
  - 依赖安装行为改变，每次都会重新解析版本
  - CI/CD 构建时间可能增加
  - 不同环境可能安装不同的依赖版本（在语义化版本范围内）
  
- **数据影响**: 无数据损坏或丢失

## 修复方案

### 代码变更
```makefile
# 修改前
cd web && bun install

# 修改后
cd web && bun install --no-cache
```

### 修复文件
- `Makefile` - 修改依赖安装命令
- `web/bun.lock` - 完全删除（766 行）

## 预防措施

### 短期措施
- [x] 在 CI/CD 中验证无 lockfile 的构建稳定性
- [ ] 监控依赖版本变化，确保不会引入破坏性更新
- [ ] 在开发文档中说明依赖管理策略变更
- [ ] 考虑添加依赖版本范围的更严格约束（如使用 `~` 而非 `^`）

### 长期措施
- [ ] 评估是否需要重新引入 lockfile 机制
- [ ] 建立依赖更新的定期审查流程
- [ ] 实施依赖版本的自动化测试
- [ ] 考虑使用 renovate 或 dependabot 进行依赖管理
- [ ] 制定明确的依赖管理策略文档

## 检测规则

### 代码模式
```makefile
# 潜在问题模式：包管理器安装命令缺少版本控制机制
bun install
npm install
yarn install
pnpm install

# 推荐模式（如果需要可重现构建）：
bun install --frozen-lockfile
npm ci
yarn install --frozen-lockfile
pnpm install --frozen-lockfile

# 或当前采用的模式（强制刷新）：
bun install --no-cache
```

### 关键词
- `bun.lock`
- `--no-cache`
- `lockfile`
- `package-lock.json`
- `yarn.lock`
- `pnpm-lock.yaml`
- `frozen-lockfile`
- `依赖版本不一致`
- `dependency resolution`

## 经验教训

### 做得好的地方
- 及时识别并解决依赖管理问题
- 通过修改构建流程确保依赖新鲜度
- 保持了 commit 的简洁性和明确性

### 需要改进的地方
- **缺少文档说明**：应在 commit message 或 PR 中详细说明移除 lockfile 的原因
- **风险评估不足**：移除 lockfile 可能导致构建不可重现，应评估影响
- **缺少替代方案**：应考虑其他依赖管理策略（如 renovate、版本范围限制）
- **测试覆盖**：应确保在不同环境下验证构建的一致性
- **团队沟通**：这种策略性变更应与团队充分讨论

## 相关链接

- Commit: 2bc306733043f68e0c28415ad5bdf734db75450c
- 相关文档: [Bun Package Manager Documentation](https://bun.sh/docs/cli/install)
- 最佳实践: [Lockfile 的利弊分析](https://docs.npmjs.com/cli/v9/configuring-npm/package-lock-json)

---

**建议后续行动**：
1. 监控生产环境构建的稳定性
2. 如果出现版本不一致问题，考虑重新引入 lockfile
3. 在团队内部达成依赖管理策略的共识
4. 建立依赖更新的审查机制
